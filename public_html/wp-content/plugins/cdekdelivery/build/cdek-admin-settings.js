(()=>{"use strict";var e={n:t=>{var c=t&&t.__esModule?()=>t.default:()=>t;return e.d(c,{a:c}),c},d:(t,c)=>{for(var n in c)e.o(c,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:c[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,c=window.jQuery;var n=e.n(c);const o=window.wp.i18n,l=window.CDEKWidget;var r=e.n(l);const a=window.wp.element,d=window.lodash,i=window.wc.wcSettings,s=({rules:e,onRulesUpdate:c})=>{const n=(t,n)=>{e[n].to=parseInt(t.target.value),e.forEach(((t,c)=>{0!==c&&null!==t.to&&t.to<=e[c-1].to&&(e[c].to=e[c-1].to+1)})),c([...e])},l=(0,a.useCallback)((0,d.debounce)(n,4e3),[e]),r=(t,n)=>{e[n].value=t.target.value,c([...e])},s=(0,a.useCallback)((0,d.debounce)(r,4e3),[e]);return e.map(((a,d)=>(0,t.createElement)("div",{key:a.to+a.value+a.type+d},(0,o.__)("Order price","cdekdelivery")," ",e[d-1]&&(0,t.createElement)(t.Fragment,null,(0,o.sprintf)((0,o.__)("from %s%s","cdekdelivery"),e[d-1].to,i.CURRENCY.symbol))," ",a.to&&(0,t.createElement)(t.Fragment,null,(0,o.__)("less or equal","cdekdelivery"),(0,t.createElement)("input",{defaultValue:a.to,min:e[d-1]?e[d-1].to+1:0,type:"number",onBlur:e=>n(e,d),onInput:e=>l(e,d)}),i.CURRENCY.symbol)," ",1===e.length&&(0,t.createElement)(t.Fragment,null,(0,o.__)("any","cdekdelivery")),", ",(0,o.__)("delivery price","cdekdelivery"),(0,t.createElement)("select",{onChange:t=>((t,n)=>{e[n].type=t.target.value,c([...e])})(t,d),className:"cdek-selector",defaultValue:a.type},(0,t.createElement)("option",{value:"free"},(0,o.__)("free","cdekdelivery")),(0,t.createElement)("option",{value:"percentage"},(0,o.__)("percentage","cdekdelivery")),(0,t.createElement)("option",{value:"fixed"},(0,o.__)("fixed on","cdekdelivery")),(0,t.createElement)("option",{value:"amount"},(0,o.__)("amount on","cdekdelivery"))),"free"!==a.type&&(0,t.createElement)("input",{defaultValue:a.value,type:"number",min:"amount"===a.type?null:0,onBlur:e=>r(e,d),onInput:e=>s(e,d)}),"percentage"===a.type&&(0,t.createElement)(t.Fragment,null,"%"),("amount"===a.type||"fixed"===a.type)&&(0,t.createElement)(t.Fragment,null,i.CURRENCY.symbol),0!==d&&(0,t.createElement)("span",{className:"button button-link-delete",onClick:()=>(t=>{t===e.length-1&&(e[t-1].to=null),c(e.filter(((e,c)=>c!==t)))})(d)},"-"))))},u=({input:e})=>{const[c,n]=(0,a.useState)([]),[l,r]=(0,a.useState)([]),i=(0,a.useCallback)((0,d.debounce)(((t,c)=>{e.val(JSON.stringify({door:t,office:c}))}),300),[]);return(0,a.useEffect)((()=>{i(c,l)}),[c,l]),(0,a.useEffect)((()=>{try{const t=JSON.parse(e.val());n(t.door),r(t.office)}catch(e){n([{to:null,type:"percentage",value:100}]),r([{to:null,type:"percentage",value:100}])}}),[]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)("div",{className:"cdek-delivery-rules"},(0,t.createElement)("div",{className:"cdek-header"},(0,t.createElement)("h4",null,(0,o.__)("Rules for delivery by courier","cdekdelivery")),(0,t.createElement)("span",{className:"button",onClick:()=>{c[c.length-1].to=(c[c.length-2]||{to:0}).to+1,n([...c,{to:null,type:"percentage",value:100}])}},"+")),(0,t.createElement)(s,{rules:c,onRulesUpdate:n}),(0,t.createElement)("div",{className:"cdek-header"},(0,t.createElement)("h4",null,(0,o.__)("Rules for delivery to pick-up","cdekdelivery")),(0,t.createElement)("span",{className:"button",onClick:()=>{l[l.length-1].to=(l[l.length-2]||{to:0}).to+1,r([...l,{to:null,type:"percentage",value:100}])}},"+")),(0,t.createElement)(s,{rules:l,onRulesUpdate:r})))};n().getJSON(window.cdek_admin_settings.api.check_auth).done((()=>n()(".token-wrong").remove())).fail((e=>{console.error(e),n()("p:contains('Custom Shipping Method for Cdek')").after('<div class="cdek-error token-wrong">[CDEKDelivery] '+(0,o.__)("Error receiving token. Make sure the integration keys are correct","cdekdelivery")+"</div>")})),n()("input#woocommerce_official_cdek_map").length&&(()=>{n()("input#woocommerce_official_cdek_map").after('<div id="cdek-map-results"></div><div id="cdek-map"></div>'),n()("#cdek-map-results").append(`<div id="selected_office"><span class="icon office"></span><div><h5>${(0,o.__)("Selected pickup point","cdekdelivery")}</h5><div class="result"></div></div></div>`).append(`<div id="selected_address"><div><h5>${(0,o.__)("Selected address","cdekdelivery")}</h5><div class="result">${(0,o.__)("Not selected","cdekdelivery")}</div></div><span class="icon door"></span></div>`);const e=n()("input[name=woocommerce_official_cdek_pvz_code]"),t=n()("input[name=woocommerce_official_cdek_address]");let c="",l="",a="";const d=()=>{const t=e.val(),r=n()("#selected_office");if(t)try{const e=JSON.parse(t);return r.addClass("selected").find(".result").html(`${e.country}; ${e.postal}; ${e.city}; ${e.address}`),c=e.city,void(l=e.address)}catch(e){}r.removeClass("selected").find(".result").html((0,o.__)("Not selected","cdekdelivery"))},i=()=>{const e=t.val(),l=n()("#selected_address");if(e)try{const t=JSON.parse(e);return l.addClass("selected").find(".result").html(`${t.country}; ${t.postal}; ${t.city}; ${t.address}`),c=t.city,void(a=t.address)}catch(e){}l.removeClass("selected").find(".result").html((0,o.__)("Not selected","cdekdelivery"))};d(),i(),new(r())({apiKey:window.cdek.apiKey,sender:!0,debug:!0,requirePostcode:!0,defaultLocation:c||"Новосибирск",servicePath:window.cdek_admin_settings.api.offices,hideFilters:{type:!0,have_cash:!0,have_cashless:!0,is_dressing_room:!0},selected:{office:l||null,door:a||null},onChoose(c,n,o){"office"===c?(e.val(JSON.stringify({country:o.country_code,postal:o.postal_code,city:o.city,address:o.code})),d()):"door"===c&&(t.val(JSON.stringify({country:o.country_code,postal:o.postal_code,city:o.city,address:o.formatted})),i())}})})();const p=n()("input#woocommerce_official_cdek_delivery_price_rules");if(p.length){const e=window.document.createElement("div");p.after(e),"function"==typeof a.render?(0,a.render)((0,t.createElement)(u,{input:p}),e):(0,a.createRoot)(e).render((0,t.createElement)(u,{input:p}))}!function(){const e=n()("#woocommerce_official_cdek_services_ban_attachment_inspection"),t=n()("#woocommerce_official_cdek_services_trying_on"),c=n()("#woocommerce_official_cdek_services_part_deliv");function o(e,t){e.prop("checked")?(t.prop("checked",!1),t.prop("disabled",!0)):t.prop("disabled",!1)}function l(e,t){e[0].prop("checked")||e[1].prop("checked")?(t.prop("checked",!1),t.prop("disabled",!0)):t.prop("disabled",!1)}o(e,t.add(c)),l([t,c],e),e.change((function(){o(n()(this),t.add(c))})),t.change((function(){l([n()(this),c],e)})),c.change((function(){l([n()(this),t],e)}))}()})();